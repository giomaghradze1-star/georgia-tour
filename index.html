<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Georgia AI Tour Guide</title>
    <style>
        :root {
            --color-primary: #208090;
            --color-primary-hover: #1a6573;
            --color-primary-active: #164d5c;
            --color-text: #134252;
            --color-text-secondary: #626c70;
            --color-bg: #fafaf8;
            --color-surface: #ffffff;
            --color-border: #d9d9d9;
            --color-success: #208090;
            --color-warning: #a84b2f;
            --color-error: #c01533;
            --color-focus-ring: rgba(32, 128, 144, 0.4);
            --space-8: 8px;
            --space-16: 16px;
            --space-24: 24px;
            --space-32: 32px;
            --radius-base: 8px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: var(--space-16);
        }

        .header {
            text-align: center;
            margin-bottom: var(--space-32);
            padding: var(--space-24) 0;
            border-bottom: 2px solid var(--color-border);
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
            color: var(--color-primary);
        }

        .header p {
            margin: var(--space-8) 0 0 0;
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-24);
            margin-bottom: var(--space-24);
            box-shadow: var(--shadow-sm);
        }

        .card h2 {
            margin: 0 0 var(--space-16) 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
        }

        .status-section {
            display: flex;
            align-items: center;
            gap: var(--space-16);
            margin-bottom: var(--space-16);
            padding: var(--space-16);
            background: rgba(32, 128, 144, 0.08);
            border-radius: var(--radius-base);
            border-left: 4px solid var(--color-primary);
        }

        .status-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .status-content h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text);
        }

        .status-content p {
            margin: var(--space-8) 0 0 0;
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .location-display {
            background: rgba(32, 128, 144, 0.05);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            margin-bottom: var(--space-16);
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }

        .location-label {
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: var(--space-8);
        }

        .location-value {
            color: var(--color-text-secondary);
        }

        .button-group {
            display: flex;
            gap: var(--space-8);
            margin-bottom: var(--space-16);
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-8);
            padding: var(--space-8) var(--space-16);
            border: none;
            border-radius: var(--radius-base);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 150ms ease-out;
            border: 1px solid transparent;
        }

        .btn:focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        .btn--primary {
            background: var(--color-primary);
            color: white;
        }

        .btn--primary:hover {
            background: var(--color-primary-hover);
        }

        .btn--primary:active {
            background: var(--color-primary-active);
        }

        .btn--secondary {
            background: transparent;
            color: var(--color-primary);
            border: 1px solid var(--color-border);
        }

        .btn--secondary:hover {
            background: rgba(32, 128, 144, 0.08);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tour-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .tour-item {
            background: rgba(32, 128, 144, 0.05);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            margin-bottom: var(--space-12);
            display: flex;
            align-items: flex-start;
            gap: var(--space-16);
        }

        .tour-item-number {
            background: var(--color-primary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .tour-item-content h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text);
        }

        .tour-item-content p {
            margin: var(--space-8) 0 0 0;
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .tour-item-distance {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: var(--space-8);
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            background: rgba(32, 128, 144, 0.08);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            margin-top: var(--space-16);
        }

        .audio-status {
            flex: 1;
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .audio-status-active {
            color: var(--color-success);
            font-weight: 600;
        }

        .narrator-select {
            width: 100%;
            padding: var(--space-8) var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            font-size: 14px;
            color: var(--color-text);
            background: var(--color-surface);
            margin-bottom: var(--space-16);
            cursor: pointer;
        }

        .narrator-select:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 0;
        }

        .form-group {
            margin-bottom: var(--space-16);
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: var(--space-8);
        }

        .info-box {
            background: rgba(168, 75, 47, 0.08);
            border-left: 4px solid var(--color-warning);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            font-size: 13px;
            color: var(--color-text-secondary);
            margin-top: var(--space-16);
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .distance-meter {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: var(--space-8);
            padding: var(--space-8);
            background: rgba(32, 128, 144, 0.05);
            border-radius: var(--radius-base);
        }

        .route-tracking {
            background: rgba(32, 128, 144, 0.08);
            border: 2px solid var(--color-primary);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            margin-bottom: var(--space-16);
        }

        .route-tracking h3 {
            margin: 0 0 var(--space-12) 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text);
        }

        .navigation-display {
            display: flex;
            align-items: center;
            gap: var(--space-16);
            background: var(--color-surface);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-12);
        }

        .direction-arrow {
            font-size: 32px;
            text-align: center;
            min-width: 40px;
        }

        .route-info {
            flex: 1;
        }

        .route-info-primary {
            font-weight: 600;
            color: var(--color-text);
            font-size: 14px;
        }

        .route-info-secondary {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: var(--space-4);
        }

        .tracking-status {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            font-size: 12px;
            color: var(--color-text-secondary);
            padding: var(--space-12);
            background: rgba(32, 128, 144, 0.05);
            border-radius: var(--radius-base);
        }

        .tracking-status.off-route {
            background: rgba(198, 21, 51, 0.08);
            border-left: 3px solid var(--color-error);
        }

        .tracking-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-success);
            animation: pulse 2s infinite;
        }

        .tracking-dot.off-route {
            background: var(--color-error);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 600px) {
            .container {
                padding: var(--space-8);
            }
            .header h1 {
                font-size: 24px;
            }
            .card {
                padding: var(--space-16);
            }
            .button-group {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Georgia AI Tour Guide</h1>
            <p>Location-based audio tours with AI narration</p>
        </div>

        <!-- Location Card -->
        <div class="card">
            <h2>üìç Your Location</h2>
            <div class="status-section">
                <div class="status-icon">
                    <span id="locationStatus" class="spinner"></span>
                </div>
                <div class="status-content">
                    <h3 id="locationTitle">Getting your location...</h3>
                    <p id="locationDesc">Requesting GPS access...</p>
                </div>
            </div>

            <div class="location-display" id="locationDisplay" style="display: none;">
                <div class="location-label">Current Coordinates:</div>
                <div class="location-value">
                    Lat: <span id="latValue">-</span>, Lon: <span id="lonValue">-</span>
                </div>
                <div class="location-label" style="margin-top: var(--space-12);">Nearest Landmark:</div>
                <div class="location-value">
                    <span id="nearestLandmark">-</span> (<span id="landmarkDistance">-</span> away)
                </div>
                <div class="tracking-status" id="trackingStatus">
                    <span class="tracking-dot"></span>
                    <span id="trackingMessage">Live tracking active</span>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn--primary" id="startLocationBtn">
                    <span>üìç</span> Get Location
                </button>
                <button class="btn btn--secondary" id="watchLocationBtn" style="display: none;">
                    <span>üîÑ</span> Stop Tracking
                </button>
            </div>
        </div>

        <!-- Tour Generation Card -->
        <div class="card" id="tourCard" style="display: none;">
            <h2>üó∫Ô∏è Your Personalized Tour</h2>
            <p style="color: var(--color-text-secondary); margin-top: 0;">
                Based on your location at <strong id="currentLocationName">-</strong>, we've generated a tour with nearby attractions.
            </p>

            <div class="route-tracking" id="routeTracking" style="display: none;">
                <h3>üìç Route Navigation</h3>
                <div class="navigation-display" id="navigationDisplay"></div>
                <div class="tracking-status" id="trackingStatus2">
                    <span class="tracking-dot"></span>
                    <span id="trackingMessage2">Following route</span>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="narratorSelect">Choose Narrator Voice:</label>
                <select class="narrator-select" id="narratorSelect">
                    <option value="default">English (Default)</option>
                    <option value="female">English (Female)</option>
                    <option value="male">English (Male)</option>
                </select>
            </div>

            <div class="button-group">
                <button class="btn btn--primary" id="startTourBtn">
                    <span>‚ñ∂Ô∏è</span> Start Audio Tour
                </button>
                <button class="btn btn--secondary" id="pauseTourBtn" style="display: none;">
                    <span>‚è∏Ô∏è</span> Pause
                </button>
                <button class="btn btn--secondary" id="stopTourBtn" style="display: none;">
                    <span>‚èπÔ∏è</span> Stop
                </button>
            </div>

            <div class="audio-controls" id="audioStatus" style="display: none;">
                <span class="audio-status">
                    <span class="audio-status-active">üîä Audio playing</span>
                </span>
                <div class="spinner" style="margin: 0;"></div>
            </div>

            <div style="margin-top: var(--space-24); border-top: 1px solid var(--color-border); padding-top: var(--space-24);">
                <h3 style="margin: 0 0 var(--space-16) 0; font-size: 16px;">Tour Stops</h3>
                <ul class="tour-list" id="tourList"></ul>
            </div>
        </div>

        <!-- Info Box -->
        <div class="info-box">
            <strong>üí° How it works:</strong> Click "Get Location" to share your GPS coordinates. The app will detect nearby attractions and generate a custom walking tour. Then hit "Start Audio Tour" to hear narrated descriptions of each stop as an audio guide.
        </div>
    </div>

    <script>
        // Sample attractions database for Georgia (Tbilisi area)
        const attractions = [
            {
                name: "Baratashvili Bridge",
                lat: 41.7265,
                lon: 44.8145,
                description: "The iconic bridge spanning the Mtkvari river. Built in 1851, Baratashvili Bridge is known as the Bridge of Love. It connects the old town to the new city and offers stunning views of Narikala Fortress. Many couples come here to attach locks symbolizing their love.",
                duration: 5,
                category: "landmark"
            },
            {
                name: "Narikala Fortress",
                lat: 41.7276,
                lon: 44.8089,
                description: "Perched on a hill overlooking old Tbilisi, Narikala Fortress dates back to the 4th century. The fortress has witnessed over 1500 years of history. From its walls, you can see panoramic views of the entire city, the Mtkvari river, and the surrounding mountains.",
                duration: 8,
                category: "fortress"
            },
            {
                name: "Anchiskhati Basilica",
                lat: 41.7290,
                lon: 44.8120,
                description: "One of the oldest churches in Georgia, built in the 6th century. Anchiskhati Basilica is located in the heart of old Tbilisi's historic district. The church is dedicated to the Holy Cross and features beautiful traditional Georgian architecture with ancient stone carvings.",
                duration: 6,
                category: "church"
            },
            {
                name: "Metekhi Church",
                lat: 41.7293,
                lon: 44.8169,
                description: "Home to the equestrian statue of Saint Nino, the patron saint of Georgia. The church was built in the 5th century and completely rebuilt in the 1980s. Inside you'll find remarkable frescoes and candles lit by devoted pilgrims from across the country.",
                duration: 5,
                category: "church"
            },
            {
                name: "Sioni Cathedral",
                lat: 41.7303,
                lon: 44.8145,
                description: "A magnificent 8th-century cathedral featuring impressive Byzantine architecture. Sioni Cathedral houses sacred relics and is famous for its ornate interior decorations. The cathedral represents the spiritual heart of the old city and attracts pilgrims and visitors year-round.",
                duration: 7,
                category: "cathedral"
            },
            {
                name: "Tbilisi Old Town",
                lat: 41.7292,
                lon: 44.8160,
                description: "Wander through the charming cobblestone streets of old Tbilisi. Narrow alleys wind between colorful 18th and 19th-century buildings with wooden balconies. The old town is filled with traditional shops, cafes, and restaurants serving authentic Georgian cuisine.",
                duration: 10,
                category: "area"
            },
            {
                name: "Abanotubani Sulfur Baths",
                lat: 41.7241,
                lon: 44.8099,
                description: "Located in the warm natural springs beneath Narikala Fortress, these historic public baths date back centuries. The domed stone structures and naturally heated sulfurous water create a unique spa experience. Relax in the traditional bathhouses after exploring the old city.",
                duration: 8,
                category: "bath"
            },
            {
                name: "Gabriadze Theater",
                lat: 41.7315,
                lon: 44.8112,
                description: "A unique marionette theater housed in a whimsical building with a clock tower. The theater features intricate puppets and creative performances telling Georgian folk tales and stories. The building itself is a work of art with colorful details and an enchanting atmosphere.",
                duration: 4,
                category: "cultural"
            }
        ];

        let currentLocation = null;
        let watchId = null;
        let currentTour = null;
        let isSpeaking = false;
        let pausedIndex = 0;
        let tourStarted = false;
        const REGENERATE_DISTANCE = 150; // meters - distance to trigger regeneration
        const ROUTE_TOLERANCE = 300; // meters - how far user can deviate before warning

        // DOM elements
        const startLocationBtn = document.getElementById('startLocationBtn');
        const watchLocationBtn = document.getElementById('watchLocationBtn');
        const startTourBtn = document.getElementById('startTourBtn');
        const pauseTourBtn = document.getElementById('pauseTourBtn');
        const stopTourBtn = document.getElementById('stopTourBtn');
        const narratorSelect = document.getElementById('narratorSelect');
        const locationDisplay = document.getElementById('locationDisplay');
        const tourCard = document.getElementById('tourCard');

        // Get user location and start continuous tracking
        function startLocationTracking() {
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by your browser');
                return;
            }

            startLocationBtn.disabled = true;
            document.getElementById('locationTitle').textContent = 'Getting your location...';
            document.getElementById('locationDesc').textContent = 'Please allow access to your location...';

            // Use watchPosition for continuous tracking instead of one-time
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const newLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };

                    // Check if user has moved significantly
                    if (currentLocation) {
                        const distanceMoved = getDistance(
                            currentLocation.lat,
                            currentLocation.lon,
                            newLocation.lat,
                            newLocation.lon
                        );

                        // Auto-regenerate tour if user moved too far or went off-route
                        if (tourStarted && distanceMoved > REGENERATE_DISTANCE) {
                            regenerateTour(newLocation);
                        }

                        // Check if user is off-route
                        if (tourStarted && currentTour) {
                            checkRouteDeviation(newLocation);
                        }
                    } else {
                        // First time getting location
                        displayLocation();
                        generateTour();
                    }

                    currentLocation = newLocation;
                    updateLocationDisplay();
                },
                (error) => {
                    showError(`Error: ${error.message}`);
                    startLocationBtn.disabled = false;
                }
            );
        }

        // Update location display with continuous coordinates
        function updateLocationDisplay() {
            document.getElementById('latValue').textContent = currentLocation.lat.toFixed(4);
            document.getElementById('lonValue').textContent = currentLocation.lon.toFixed(4);
            
            const nearest = findNearestAttraction();
            document.getElementById('nearestLandmark').textContent = nearest.name;
            document.getElementById('landmarkDistance').textContent = 
                (nearest.distance * 1000).toFixed(0) + ' meters';
        }

        // Display location info
        function displayLocation() {
            updateLocationDisplay();
            
            const nearest = findNearestAttraction();
            document.getElementById('locationTitle').textContent = 'üìç Location Found';
            document.getElementById('locationDesc').textContent = 
                `You are near ${nearest.name} (${(nearest.distance * 1000).toFixed(0)}m away)`;
            
            locationDisplay.style.display = 'block';
            startLocationBtn.style.display = 'none';
            watchLocationBtn.style.display = 'inline-flex';
        }

        // Calculate distance between two coordinates
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Find nearest attraction
        function findNearestAttraction() {
            let nearest = null;
            let minDistance = Infinity;

            attractions.forEach(attr => {
                const dist = getDistance(currentLocation.lat, currentLocation.lon, attr.lat, attr.lon);
                if (dist < minDistance) {
                    minDistance = dist;
                    nearest = { ...attr, distance: dist };
                }
            });

            return nearest;
        }

        // Generate tour based on location
        function generateTour() {
            if (!currentLocation) return;

            // Get nearest 5 attractions within 2km
            const nearbyAttractions = attractions
                .map(attr => ({
                    ...attr,
                    distance: getDistance(currentLocation.lat, currentLocation.lon, attr.lat, attr.lon)
                }))
                .filter(attr => attr.distance <= 2)
                .sort((a, b) => a.distance - b.distance)
                .slice(0, 5);

            if (nearbyAttractions.length === 0) {
                showError('No attractions found nearby. Please try a different location.');
                return;
            }

            currentTour = nearbyAttractions;
            pausedIndex = 0;
            document.getElementById('currentLocationName').textContent = findNearestAttraction().name;
            
            // Render tour stops
            const tourList = document.getElementById('tourList');
            tourList.innerHTML = '';
            
            currentTour.forEach((stop, index) => {
                const li = document.createElement('li');
                li.className = 'tour-item';
                li.innerHTML = `
                    <div class="tour-item-number">${index + 1}</div>
                    <div class="tour-item-content">
                        <h3>${stop.name}</h3>
                        <p>${stop.description.substring(0, 100)}...</p>
                        <div class="tour-item-distance">
                            ‚è±Ô∏è ${stop.duration} min ‚Ä¢ üìç ${(stop.distance * 1000).toFixed(0)}m
                        </div>
                    </div>
                `;
                tourList.appendChild(li);
            });

            tourCard.style.display = 'block';
            updateNavigationDisplay();
        }

        // Regenerate tour when user moves to a different area
        function regenerateTour(newLocation) {
            currentLocation = newLocation;
            console.log('User moved significantly - regenerating tour...');
            
            // Pause audio if playing
            if (isSpeaking) {
                speechSynthesis.cancel();
                isSpeaking = false;
            }

            // Regenerate tour
            generateTour();
            
            // Show notification
            const msg = `üìç You've moved to a new area! Tour regenerated based on ${findNearestAttraction().name}.`;
            document.getElementById('navigationDisplay').innerHTML = `
                <div style="background: rgba(32, 128, 144, 0.1); padding: 12px; border-radius: 6px; width: 100%; text-align: center; font-weight: 600; color: var(--color-primary);">
                    ${msg}
                </div>
            `;
        }

        // Check if user is deviating from the planned route
        function checkRouteDeviation(newLocation) {
            if (!currentTour || currentTour.length === 0) return;

            // Calculate distance to nearest tour stop
            let minDistanceToTour = Infinity;
            currentTour.forEach(stop => {
                const dist = getDistance(newLocation.lat, newLocation.lon, stop.lat, stop.lon);
                minDistanceToTour = Math.min(minDistanceToTour, dist);
            });

            const statusEl = document.getElementById('trackingStatus2');
            const trackingMsg = document.getElementById('trackingMessage2');

            if (minDistanceToTour > (ROUTE_TOLERANCE / 1000)) {
                // User is off-route
                statusEl.classList.add('off-route');
                const dot = statusEl.querySelector('.tracking-dot');
                dot.classList.add('off-route');
                trackingMsg.textContent = `‚ö†Ô∏è Off route (${(minDistanceToTour * 1000).toFixed(0)}m away)`;
            } else {
                statusEl.classList.remove('off-route');
                const dot = statusEl.querySelector('.tracking-dot');
                dot.classList.remove('off-route');
                trackingMsg.textContent = '‚úì Following route';
            }
        }

        // Update navigation display with direction to next stop
        function updateNavigationDisplay() {
            if (!currentTour || tourStarted === false) return;

            const nextStop = currentTour[pausedIndex];
            if (!nextStop) return;

            const distanceToNext = getDistance(
                currentLocation.lat,
                currentLocation.lon,
                nextStop.lat,
                nextStop.lon
            ) * 1000; // Convert to meters

            // Determine direction arrow
            let arrow = '‚Üì';
            if (distanceToNext < 50) {
                arrow = 'üìç'; // Arrived
            } else if (distanceToNext < 200) {
                arrow = '‚û°Ô∏è'; // Close
            }

            document.getElementById('navigationDisplay').innerHTML = `
                <div class="direction-arrow">${arrow}</div>
                <div class="route-info">
                    <div class="route-info-primary">Next: ${nextStop.name}</div>
                    <div class="route-info-secondary">${distanceToNext.toFixed(0)}m away ‚Ä¢ ${nextStop.duration} min stop</div>
                </div>
            `;

            // Show routing section
            document.getElementById('routeTracking').style.display = 'block';
        }

        // Start audio tour
        async function startAudioTour() {
            if (!currentTour || currentTour.length === 0) return;

            tourStarted = true;
            startTourBtn.style.display = 'none';
            pauseTourBtn.style.display = 'inline-flex';
            stopTourBtn.style.display = 'inline-flex';
            document.getElementById('audioStatus').style.display = 'flex';
            document.getElementById('routeTracking').style.display = 'block';
            isSpeaking = true;

            for (let i = pausedIndex; i < currentTour.length; i++) {
                if (!isSpeaking) break;

                const stop = currentTour[i];
                pausedIndex = i;

                // Update navigation display
                updateNavigationDisplay();

                // Build narration
                const narration = `Stop ${i + 1} of ${currentTour.length}. ` +
                    `You have arrived at ${stop.name}. ` +
                    stop.description + 
                    `. This stop should take about ${stop.duration} minutes to explore. ` +
                    (i < currentTour.length - 1 ? `Next, head to stop ${i + 2}.` : `This concludes your tour.`);

                await speakText(narration);
            }

            if (isSpeaking) {
                endTour();
            }
        }

        // Text to speech using Web Speech API
        function speakText(text) {
            return new Promise((resolve) => {
                if (!('speechSynthesis' in window)) {
                    console.error('Speech synthesis not supported');
                    resolve();
                    return;
                }

                const utterance = new SpeechSynthesisUtterance(text);
                
                // Get selected voice
                const voiceSelect = narratorSelect.value;
                const voices = speechSynthesis.getVoices();
                
                if (voiceSelect === 'female' && voices.length > 1) {
                    utterance.voice = voices[1];
                } else if (voiceSelect === 'male' && voices.length > 2) {
                    utterance.voice = voices[2];
                }

                utterance.rate = 1;
                utterance.pitch = 1;
                utterance.volume = 0.8;

                utterance.onend = () => {
                    resolve();
                };

                utterance.onerror = () => {
                    resolve();
                };

                speechSynthesis.speak(utterance);
            });
        }

        // Pause tour
        function pauseTour() {
            isSpeaking = false;
            speechSynthesis.cancel();
            pauseTourBtn.style.display = 'none';
            stopTourBtn.style.display = 'inline-flex';
            startTourBtn.textContent = '‚ñ∂Ô∏è Resume Tour';
            startTourBtn.style.display = 'inline-flex';
            document.getElementById('audioStatus').style.display = 'none';
        }

        // Stop tour
        function stopTour() {
            isSpeaking = false;
            tourStarted = false;
            pausedIndex = 0;
            speechSynthesis.cancel();
            pauseTourBtn.style.display = 'none';
            stopTourBtn.style.display = 'none';
            startTourBtn.textContent = '‚ñ∂Ô∏è Start Audio Tour';
            startTourBtn.style.display = 'inline-flex';
            document.getElementById('audioStatus').style.display = 'none';
            document.getElementById('routeTracking').style.display = 'none';
        }

        // End tour
        function endTour() {
            tourStarted = false;
            pausedIndex = 0;
            pauseTourBtn.style.display = 'none';
            stopTourBtn.style.display = 'none';
            startTourBtn.textContent = '‚ñ∂Ô∏è Start Audio Tour';
            startTourBtn.style.display = 'inline-flex';
            document.getElementById('audioStatus').style.display = 'none';
            document.getElementById('routeTracking').style.display = 'none';
            alert('Tour complete! Thank you for exploring Georgia with us.');
        }

        // Show error
        function showError(message) {
            alert(message);
        }

        // Event listeners
        startLocationBtn.addEventListener('click', startLocationTracking);
        watchLocationBtn.addEventListener('click', () => {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            locationDisplay.style.display = 'none';
            tourCard.style.display = 'none';
            startLocationBtn.style.display = 'inline-flex';
            watchLocationBtn.style.display = 'none';
            currentLocation = null;
            tourStarted = false;
            startLocationBtn.disabled = false;
            stopTour();
        });

        startTourBtn.addEventListener('click', startAudioTour);
        pauseTourBtn.addEventListener('click', pauseTour);
        stopTourBtn.addEventListener('click', stopTour);

        // Load voices on page load
        window.addEventListener('load', () => {
            if ('speechSynthesis' in window) {
                speechSynthesis.getVoices();
            }
        });
    </script>
</body>
</html>
